
<!DOCTYPE html>
<html lang="it" data-bs-theme="dark">
<head>
    <div th:replace="fragments/header :: header"></div>
    <title>Profilo Utente</title>
    <style>
        /* Avatar Profilo Principale */
        .profile-header-avatar {
            width: 160px;
            height: 160px;
            object-fit: cover;
            border: 6px solid #212529;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            background-color: #212529;
        }
        
/* Card Info Principale */
        .profile-card {
            background: linear-gradient(145deg, #1a1d20, #212529);
            border: none;
            border-radius: 15px;
            
            /* MODIFICA QUI: Invece di -80px, usiamo un margine positivo */
            /* Questo spinge la card gi√π per lasciare spazio alla testa dell'avatar */
            margin-top: 80px; 
            
            padding-top: 90px;
            position: relative; /* Fondamentale per l'avatar absolute */
            overflow: visible;  /* Permette all'avatar di uscire dai bordi */
        }

        /* Selettore Vista */
        .view-selector {
            background-color: #0d6efd;
            border: none;
            color: white;
            font-weight: bold;
            text-align: center;
            text-align-last: center; /* Centra il testo nel dropdown */
            cursor: pointer;
            transition: background 0.3s;
        }
        .view-selector:hover, .view-selector:focus {
            background-color: #0b5ed7;
            box-shadow: 0 0 10px rgba(13, 110, 253, 0.5);
        }
        option { background-color: #212529; color: white; }

        /* Card Statistiche */
        .stat-box {
            background-color: #2c3034;
            border-radius: 12px;
            transition: transform 0.2s;
            border-left: 5px solid #0d6efd;
        }
        .stat-box:hover { transform: translateY(-5px); background-color: #343a40; }
        
        /* Immagini Stock nel Modale */
        .stock-avatar {
            width: 70px; height: 70px; 
            object-fit: cover; border-radius: 50%; 
            cursor: pointer; border: 3px solid transparent; 
            transition: all 0.2s;
        }
        .stock-avatar:hover { transform: scale(1.1); }
        .stock-avatar.selected { border-color: #0d6efd; transform: scale(1.15); box-shadow: 0 0 10px #0d6efd; }
        
        /* STILI CERCHIO LIVELLO (Presi da Achivement.html) */
        .progress_container {
            position: relative;
            width: 150px;
            height: 150px;
            margin: 0 auto; /* Centrato */
        }
        .progress-svg {
            transform: rotate(-90deg);
        }
        .progress_background {
            fill: none;
            stroke: #333;
            stroke-width: 12;
        }
        .progress_fill {
            fill: none;
            stroke: #d10b4f; /* Colore originale del cerchio */
            stroke-width: 12;
            stroke-linecap: round;
            stroke-dasharray: 314; /* Circonferenza */
            stroke-dashoffset: 314; /* Inizia vuoto */
            transition: stroke-dashoffset 1.5s ease-in-out;
        }
        .progress_value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            font-weight: bold;
            color: white;
        }
    
    </style>
</head>

<body class="bg-dark text-light">
<div th:replace="fragments/navbar :: navbar"></div>

<!--<div style="height: 60px;"></div>-->

<div class="container pb-5">

    <div class="row justify-content-center mb-4">
        <div class="col-md-8">
            <div class="alert alert-success alert-dismissible fade show shadow" role="alert" th:if="${successMsg != null}">
                <i class="bi bi-check-circle-fill me-2"></i> <strong th:text="${successMsg}"></strong>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            <div class="alert alert-danger alert-dismissible fade show shadow" role="alert" th:if="${errorMsg != null}">
                <i class="bi bi-exclamation-triangle-fill me-2"></i> <strong th:text="${errorMsg}"></strong>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        </div>
    </div>

                <div class="row justify-content-center" th:if="${userInfo != null}">

                        <div class="col-lg-8">

                            <div class="card profile-card shadow text-center position-relative">

                                <div class="position-absolute top-0 start-50 translate-middle">

                                    <img th:src="${userInfo.userProfile.profilePicturePath != null ? '/t5/images/profileImages/' + userInfo.userProfile.profilePicturePath : '/t5/images/default.png'}"

                                        class="rounded-circle profile-header-avatar" alt="Avatar">

                                </div>

                <div class="card-body px-5 pb-4">
                    <h2 class="fw-bold mb-0" th:text="${userInfo.userProfile.name} + ' ' + ${userInfo.userProfile.surname}">Nome</h2>
                    
                    <p class="text-primary mb-3 fw-semibold" 
                       th:if="${userInfo.userProfile.nickname}"
                       th:text="'@' + ${userInfo.userProfile.nickname}">
                       @nickname
                    </p>

                    <div class="bg-dark bg-opacity-50 p-3 rounded mb-4 d-inline-flex align-items-start justify-content-center" style="max-width: 600px;">
                        
                        <i class="bi bi-quote text-secondary me-2" 
                        style="font-size: 0.9rem; transform: translateY(-3px);"></i>
                        
                        <span class="fst-italic text-light" 
                            style="line-height: 1.4;"
                            th:text="${userInfo.userProfile.bio ?: 'Nessuna biografia.'}"></span>
                        
                        <i class="bi bi-quote text-secondary ms-2" 
                        style="font-size: 0.9rem; transform: scaleX(-1) translateY(-3px); display: inline-block;"></i>
                    </div>
                    <div>
                        <button class="btn btn-warning px-4 fw-bold rounded-pill" onclick="toggleEditMode()">
                            <i class="bi bi-pencil-fill me-2" th:text="#{edit_profile}"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="edit-overlay" class="position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-75" style="display: none; z-index: 1050; overflow-y: auto;">
        <div class="d-flex justify-content-center align-items-center min-vh-100 py-5">
            <div class="card bg-dark border-secondary shadow-lg text-light" style="width: 90%; max-width: 600px;">
                <div class="card-header border-secondary bg-black d-flex justify-content-between align-items-center">
                    <h4 class="mb-0 text-warning"><i class="bi bi-palette-fill me-2" th:text="#{edit}"></i></h4>
                    <button type="button" class="btn-close btn-close-white" onclick="toggleEditMode()"></button>
                </div>
                <div class="card-body p-4">
                    <form th:action="@{/profile}" method="post">
                        <input type="hidden" name="email" th:value="${userInfo.email}">
                        <input type="hidden" id="selectedImageInput" name="selectedImage" th:value="${userInfo.userProfile.profilePicturePath}">

                        <h5 class="mb-3 text-secondary" th:text="#{choose_avatar}"></h5>
                        <div class="d-flex flex-wrap justify-content-center gap-3 mb-4 p-3 bg-black rounded border border-secondary">
                            <img th:each="imgName : ${stockImages}"
                                 th:src="@{'/t5/images/profileImages/' + ${imgName}}"
                                 class="stock-avatar"
                                 th:classappend="${imgName == userInfo.userProfile.profilePicturePath} ? 'selected' : ''"
                                 th:attr="data-filename=${imgName}"
                                 onclick="selectAvatar(this)">
                        </div>

                        <div class="mb-4">
                            <label class="form-label text-secondary fw-bold" th:text="#{bio}"></label>
                            <textarea class="form-control bg-dark text-light border-secondary" name="bio" rows="3" 
                                      th:text="${userInfo.userProfile.bio}"></textarea>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-success btn-lg fw-bold" th:text="#{save_mod}"></button>
                            <button type="button" class="btn btn-outline-secondary" onclick="toggleEditMode()" th:text="#{undo}"></button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="row justify-content-center mt-5" th:if="${userInfo != null}">
        <div class="col-lg-10">
            
            <div class="mb-4 position-relative">
                <select id="viewSelector" class="form-select form-select-lg view-selector rounded-pill shadow-sm" onchange="changeView(this.value)">
                    <option value="stats" th:text="#{player_stats}"></option>
                    <option value="history" th:text="#{history}"></option>
                    <option value="achievements" th:text="#{achieve}"></option>
                    <option value="social" th:text="#{social_and_friend}"></option>
                </select>
            </div>

            <div class="bg-dark rounded-4 p-4 shadow border border-secondary border-opacity-25" style="min-height: 300px;">
                
                <div id="view-stats" class="view-section">
                    <div th:if="${playerProgress == null}" class="text-center py-5 text-muted">
                        <i class="bi bi-hourglass-split fs-1 d-block mb-3" th:text="#{loading_stats}"></i>
                        <h4></h4>
                        <p th:text="#{alert_stats}"></p>
                    </div>
                    
                    <div th:if="${playerProgress != null}" class="row g-4 text-center">
                        <div class="col-md-4">
                            <div class="stat-box p-4 h-100">
                                <h1 class="display-4 fw-bold text-primary mb-0" th:text="${playerProgress.experiencePoints}">0</h1>
                                <p class="text-uppercase text-muted small fw-bold spacing-2" th:text="#{exp_points}"></p>
                            </div>
                        </div>
                    <div class="col-md-4">
                        <div class="stat-box p-4 h-100" style="border-left-color: #08a75d;">
                            <h1 class="display-4 fw-bold text-success mb-0" th:text="${playerProgress.gameProgressesDTO != null ? playerProgress.gameProgressesDTO.size() : 0}">0</h1>
                            <p class="text-uppercase text-muted small fw-bold spacing-2" th:text="#{tot_matches}"></p>
                        </div>
                    </div>
                        <div class="col-md-4">
                            <div class="stat-box p-4 h-100 border-warning" style="border-left-color: #ffc107;">
                                <h1 class="display-4 fw-bold text-warning mb-0" th:text="${playerProgress.gameProgressesDTO != null ? playerProgress.gameProgressesDTO.?[isWon == true].size() : 0}">0</h1>
                                <p class="text-uppercase text-muted small fw-bold spacing-2" th:text="#{wins}"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="view-history" class="view-section d-none">
                    <h4 class="border-bottom border-secondary pb-2 mb-3" th:text="#{last_matches}"></h4>
                    <div class="table-responsive">
                        <table class="table table-dark table-hover align-middle" th:if="${playerProgress != null}">
                            <thead><tr><th th:text="#{last_matches}">Classe</th><th th:text="#{mod}"></th><th th:text="#{res}"></th></tr></thead>
                            <tbody>
                                <tr th:each="game : ${playerProgress.gameProgressesDTO}">
                                    <td th:text="${game.classUT}">Class</td>
                                    <td th:text="${game.gameMode}">Mode</td>
                                    <td>
                                        <span class="badge rounded-pill" 
                                              th:classappend="${game.isWon} ? 'text-bg-success' : 'text-bg-danger'"
                                              th:text="${game.isWon} ? #{victory} : #{defeat}"></span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div th:if="${playerProgress == null}" class="text-center text-muted" th:text="#{no_history}">.</div>
                </div>

                <div id="view-achievements" class="view-section d-none">    
                    <div class="d-sm-flex align-items-center justify-content-around mt-3 mb-5 p-4 rounded border border-secondary"
                         style="background-color: #212529;">
                        
                        <div class="text-center">
                            <h4 class="mb-0 fw-semibold lh-1" th:text="${userCurrentExperience}">0</h4>
                            <p class="mb-0 fs-5 text-muted" th:text="#{tot_points}"></p>
                        </div>
                        
                        <div class="progress_container" 
                             th:if="${userCurrentExperience != null}"
                             th:attr="data-progress=(${userCurrentExperience} % ${expPerLevel}) / ${expPerLevel}">
                            <svg class="progress-svg" width="150" height="150" viewBox="0 0 120 120">
                                <circle class="progress_background" cx="60" cy="60" r="50" style="stroke: #1a1d20;" />
                                <circle class="progress_fill" cx="60" cy="60" r="50" />
                            </svg>
                            <div class="progress_value"
                                 th:text="${(userCurrentExperience / expPerLevel) + startingLevel == maxLevel} ? 'Lv. MAX' : 'Lv. ' + ${(userCurrentExperience / expPerLevel) + startingLevel}">
                                Lv. 1
                            </div>
                        </div>

                        <div class="text-center">
                            <h4 class="mb-0 fw-semibold lh-1" 
                                th:text="${userCurrentExperience != null ? (expPerLevel - (userCurrentExperience % expPerLevel)) : 100}">100</h4>
                            <p class="mb-0 fs-5 text-muted" th:text="#{xp_level}"></p>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between align-items-center border-bottom border-secondary pb-2 mb-3">
                        <h5 class="mb-0" th:text="#{achieve_obt}"></h5>
                    </div>

                    <div class="row row-cols-1 row-cols-md-2 g-3" th:if="${playerProgress != null}">
                        <div class="col" th:each="ach : ${playerProgress.globalAchievements}">
                            <div class="d-flex align-items-center p-3 rounded border border-secondary"
                                 style="background-color: #212529;">
                                <i class="bi bi-trophy-fill text-warning fs-2 me-3"></i>
                                <div>
                                    <h6 class="mb-0 text-light" th:text="${ach}">Nome Achievement</h6>
                                    <small class="text-success" th:text="#{unlocked}"></small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div th:if="${playerProgress == null or playerProgress.globalAchievements == null or playerProgress.globalAchievements.isEmpty()}" class="text-center text-muted mt-5">
                        <i class="bi bi-lock-fill fs-1 opacity-50"></i>
                        <p class="mt-2 fw-semibold" th:text="#{no_achieve}"></p>
                    </div>
                </div>

<div id="view-social" class="view-section d-none">
                    <div class="d-flex justify-content-between mb-3">
                        <div class="btn-group">
                            <button class="btn btn-outline-light active" id="btn-show-followers" onclick="showSocialTab('followers')" th:text="#{followerss}"></button>
                            <button class="btn btn-outline-light" id="btn-show-following" onclick="showSocialTab('following')" th:text="#{following}"></button>
                        </div>
                        <a href="/SearchFriend" class="btn btn-primary"><i class="bi bi-person-plus" th:text="#{search}"></i></a>
                    </div>
                    
                    <div id="followers_block" class="row g-3">
                        <div class="col-md-6" th:each="u : ${followersList}">
                            <div class="p-3 rounded d-flex align-items-center gap-3 border border-secondary" 
                                 style="background-color: #2c3034 !important;" 
                                 th:if="${u != null}">
                                
                                <img th:src="${u['profilePicturePath'] != null ? '/t5/images/profileImages/' + u['profilePicturePath'] : '/t5/images/profileImages/default.png'}" 
                                     class="rounded-circle" style="width:50px; height:50px; object-fit:cover;"
                                     alt="Avatar">
                                
                                <div>
                                    <h6 class="mb-0 text-light" th:text="${u['name'] + ' ' + u['surname']}">Nome</h6>
                                    <small class="text-muted" th:text="'@' + ${u['nickname']}">@nick</small>
                                </div>
                                
                                <a th:href="@{'/friend/' + ${u['userId']}}" class="btn btn-sm btn-outline-primary ms-auto" th:text="#{view}"></a>
                            </div>
                        </div>
                        <div th:if="${followersList == null or followersList.isEmpty()}" class="col-12 text-center text-muted" th:text="#{no_follower}"></div>
                    </div>

                    <div id="following_block" class="row g-3 d-none">
                        <div class="col-md-6" th:each="u : ${followingList}">
                            
                            <div class="p-3 rounded d-flex align-items-center gap-3 border border-secondary"
                                 style="background-color: #2c3034 !important;" 
                                 th:if="${u != null}">
                                
                                <img th:src="${u['profilePicturePath'] != null ? '/t5/images/profileImages/' + u['profilePicturePath'] : '/t5/images/profileImages/default.png'}" 
                                     class="rounded-circle" style="width:50px; height:50px; object-fit:cover;"
                                     alt="Avatar">
                                
                                <div>
                                    <h6 class="mb-0 text-light" th:text="${u['name'] + ' ' + u['surname']}">Nome</h6>
                                    <small class="text-muted" th:text="'@' + ${u['nickname']}">@nick</small>
                                </div>
                                
                                <a th:href="@{'/friend/' + ${u['userId']}}" class="btn btn-sm btn-outline-primary ms-auto" th:text="#{view}"></a>
                            </div>
                        </div>
                        <div th:if="${followingList == null or followingList.isEmpty()}" class="col-12 text-center text-muted" th:text="#{no_following}"></div>
                    </div>
                </div>


                
            </div>
        </div>
    </div>
</div>

<div th:replace="fragments/footer :: footer"></div>

<span class="d-none" id="userProfileID" th:text="${userInfo != null ? userInfo.userProfile.id : ''}"></span>

<span id="viewText" style="display: none;" th:text="#{view}"></span>
<span id="serchNotFoundText" style="display: none;" th:text="#{search_not_found}"></span>

<script>
    // menu a tendina 
        function changeView(viewName) {
        // Nascondi tutte le sezioni
        document.querySelectorAll('.view-section').forEach(el => el.classList.add('d-none'));
        // Mostra quella selezionata
        document.getElementById('view-' + viewName).classList.remove('d-none');

        // animazione cerchio livello
        if (viewName === 'achievements') {
            setTimeout(() => {
                let progressContainer = document.querySelector('.progress_container');
                if (progressContainer) {


                    let progressStr = progressContainer.getAttribute('data-progress');
                    let progress = eval(progressStr); 
                    
                    let progressFill = document.querySelector(".progress_fill");
                    
                    let offset = 314 * (1 - progress);
                    progressFill.style.strokeDashoffset = offset;
                }
            }, 100); // Piccolo ritardo per permettere al div di diventare visibile
        }
    }
    

    // gestione modale modifica profilo
    function toggleEditMode() {
        const overlay = document.getElementById('edit-overlay');
        overlay.style.display = (overlay.style.display === 'none' || overlay.style.display === '') ? 'block' : 'none';
        if(overlay.style.display === 'block') document.body.style.overflow = 'hidden'; // Blocca scroll
        else document.body.style.overflow = 'auto'; // Riattiva scroll
    }

    // gestione selezione avatar
    function selectAvatar(imgElement) {
        document.querySelectorAll('.stock-avatar').forEach(el => el.classList.remove('selected'));
        imgElement.classList.add('selected');
        const filename = imgElement.getAttribute('data-filename');
        document.getElementById('selectedImageInput').value = filename;
    }

    // gestione tab social
    function showSocialTab(type) {
        document.getElementById('btn-show-followers').classList.remove('active');
        document.getElementById('btn-show-following').classList.remove('active');
        document.getElementById('btn-show-' + type).classList.add('active');

        if(type === 'followers') {
            document.getElementById('followers_block').classList.remove('d-none');
            document.getElementById('following_block').classList.add('d-none');
        } else {
            document.getElementById('followers_block').classList.add('d-none');
            document.getElementById('following_block').classList.remove('d-none');
        }
    }

    // Caricamento Ajax Social al load
    document.addEventListener("DOMContentLoaded", function() {
        const userId = document.getElementById('userProfileID').innerText;
        if(!userId) return;

        function loadUsers(endpoint, containerId) {
            fetch(endpoint + "?userId=" + userId)
                .then(res => res.json())
                .then(users => {
                    const container = document.getElementById(containerId);
                    container.innerHTML = "";
                    if(!users || users.length === 0) {

                        const searchNotFound = $("#serchNotFoundText").text();
                        container.innerHTML = `<p class='text-muted text-center w-100'>${searchNotFound}</p>`;
                        return;
                    }
                    users.forEach(u => {
                        const viewText = $("#viewText").text();
                        const imgPath = u.profilePicturePath ? '/t5/images/profileImages/' + u.profilePicturePath : '/t5/images/default.png';
                        container.innerHTML += `
                            <div class="col-md-6">
                                <div class="bg-black p-3 rounded d-flex align-items-center gap-3 border border-secondary">
                                    <img src="${imgPath}" class="rounded-circle" style="width:50px; height:50px; object-fit:cover;">
                                    <div>
                                        <h6 class="mb-0 text-light">${u.name} ${u.surname}</h6>
                                        <small class="text-muted">@${u.nickname}</small>
                                    </div>
                                    <a href="/friend/${u.userId}" class="btn btn-sm btn-outline-primary ms-auto">${viewText}</a>
                                </div>
                            </div>
                        `;
                    });
                })
                .catch(err => console.error("Err Social:", err));
        }

// chiamate per caricare followers e following
        loadUsers("/profile/followers", "followers_block");
        loadUsers("/profile/following", "following_block");
    });
</script>

</body>
</html>