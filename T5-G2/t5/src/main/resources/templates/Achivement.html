<!DOCTYPE html>
<html lang="it" data-bs-theme="dark">
<head>
    <div th:replace="fragments/header :: header"></div>
    <title>Profile</title>
    <style>
        .progress_container {
            position: relative;
            width: 150px;
            height: 150px;
        }
        .progress-svg {
            transform: rotate(-90deg);
        }
        .progress_background {
            fill: none;
            stroke: #333;
            stroke-width: 12;
        }
        .progress_fill {
            fill: none;
            stroke: #d10b4f;
            stroke-width: 12;
            stroke-linecap: round;
            stroke-dasharray: 314;
            stroke-dashoffset: 314;
            transition: stroke-dashoffset 1.5s ease-in-out;
        }
        .progress_value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            font-weight: bold;
            color: white;
        }

        .achievement-img {
            width: 75px;
            height: 75px;
            object-fit: contain;
        }

        .class-ut {
            font-size: 1.2rem;
            font-weight: bold;
            color: #d10b4f;
            margin-top: 20px;
            padding: 5px 0;
            border-bottom: 2px solid #d10b4f;
        }

        .robot-difficulty {
            font-size: 1rem;
            font-weight: 600;
            margin-top: 10px;
            color: #ffcc00;
        }

        .achievements-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            padding: 10px 0;
            width: 100%;
        }

        .achievement-item {
            display: flex;
            align-items: center;
            background-color: #222;
            border-radius: 8px;
            padding: 10px;
            gap: 10px;
            min-width: 250px;
            width: 100%;
        }

        .achievement-item img {
            width: 50px;
            height: 50px;
            object-fit: contain;
        }

        .achievement-info h6 {
            margin: 0;
            font-size: 0.95rem;
        }

        .achievement-info p {
            margin: 0;
            font-size: 0.85rem;
            color: #aaa;
        }



    </style>
</head>
<body>
<div th:replace="fragments/navbar :: navbar"></div>

<div class="container">
    <div class="d-sm-flex align-items-center justify-content-around mt-3 mb-5">
        <div class="text-center">
            <h4 class="mb-0 fw-semibold lh-1" th:text="${userCurrentExperience}"></h4>
            <p class="mb-0 fs-5" th:text="#{total_exp_label}"></p>
        </div>
        <div class="progress_container" th:attr="data-progress=(${userCurrentExperience} % ${expPerLevel}) / ${expPerLevel}">
            <svg class="progress-svg" width="150" height="150" viewBox="0 0 120 120">
                <circle class="progress_background" cx="60" cy="60" r="50" />
                <circle class="progress_fill" cx="60" cy="60" r="50" />
            </svg>
            <div class="progress_value"
                 th:text="${(userCurrentExperience / expPerLevel) + startingLevel == maxLevel} ? 'Lv. MAX' : 'Lv. ' + ${(userCurrentExperience / expPerLevel) + startingLevel}">
            </div>
        </div>
        <div class="text-center">
            <h4 class="mb-0 fw-semibold lh-1" th:text="${expPerLevel - (userCurrentExperience % expPerLevel)}"></h4>
            <p class="mb-0 fs-5" th:text="#{exp_next_level_label}"></p>
        </div>
    </div>

    <div class="container mt-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span th:text="#{achievements_list}"></span>
                <select id="game-mode-select" class="form-select w-auto">
                    <option value="PartitaSingola"></option>
                    <option value="General"></option>
                </select>
            </div>
            <div class="card-body d-flex flex-wrap" id="achievements-container"></div>
        </div>
    </div>
</div>

<div th:replace="fragments/footer :: footer"></div>

<script th:inline="javascript">
    let gamemode_achievements = /*[[${gamemode_achievements}]]*/ [];
    let general_achievements = /*[[${general_achievements}]]*/ [];

    console.log("gamemode_achievements", gamemode_achievements);
    console.log("general_achievements", general_achievements);

    let difficultyTranslation = {
        easy: /*[[#{d_facile}]]*/ "Facile",
        medium: /*[[#{d_medio}]]*/ "Medio",
        hard: /*[[#{d_difficile}]]*/ "Difficile"
    };
    const achievementData = {
        "instructions": {
            name: /*[[#{instructions_name}]]*/ "Coverage Master",
            descr: /*[[#{instructions_descr}]]*/ "Ottenuto superando il robot nel numero di istruzioni coperte per la classe sotto test."
        },
        "instructionsAndWeakMutation": {
            name: /*[[#{instructionsAndWeakMutation_name}]]*/ "Signore delle Weak Mutation",
            descr: /*[[#{instructionsAndWeakMutation_descr}]]*/ "Ottenuto superando il robot sia nel numero di istruzioni coperte che nella metrica weakMutation."
        },
        "firstMatchWon": {
            name: /*[[#{firstMatchWon_text}]]*/ "Primi passi",
            descr: /*[[#{firstMatchWon_descr}]]*/ "Ottenuto vincendo la tua prima partita."
        },
        "thirdMatchWon": {
            name: /*[[#{thirdMatchWon_text}]]*/ "In ritmo",
            descr: /*[[#{thirdMatchWon_descr}]]*/ "Ottenuto vincendo la tua terza partita."
        },
        "allBeatenOneClass": {
            name: /*[[#{allBeatenOneClass_text}]]*/ "Classe completata",
            descr: /*[[#{allBeatenOneClass_descr}]]*/ "Ottenuto superando tutti gli avversari di una classe."
        },
        "allBeatenTwoClass": {
            name: /*[[#{allBeatenTwoClass_text}]]*/ "Doppia padronanza",
            descr: /*[[#{allBeatenTwoClass_descr}]]*/ "Ottenuto superando tutti gli avversari di due classi."
        }
    };

    const gameMode = {
        PartitaSingola: /*[[#{singola}]]*/ "Partita Singola",
        Allenamento: /*[[#{allenamento}]]*/ "Allenamento",
        Multiplayer: /*[[#{multiplayer}]]*/ "Multi-giocatore",
        Scalata: /*[[#{scalata}]]*/ "Scalata",
    }

    const no_achievement_message = /*[[#{no_achievement_message}]]*/ "Nessun achievement sbloccato";
    const general = /*[[#{general}]]*/ "Generici";
</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelector('option[value="PartitaSingola"]').textContent = gameMode.PartitaSingola;
        document.querySelector('option[value="General"]').textContent = general;

        let progressContainer = document.querySelector('.progress_container');
        let progress = parseFloat(progressContainer.getAttribute('data-progress'));
        let progressFill = document.querySelector(".progress_fill");
        // Rapporto il progresso al perimetro della progress bar (2*pi*r con r=50)
        let offset = 314 * (1 - progress);
        progressFill.style.strokeDashoffset = offset;

        function groupBy(array, key) {
            return array.reduce((result, item) => {
                (result[item[key]] = result[item[key]] || []).push(item);
                return result;
            }, {});
        }

        function renderGeneralAchievements() {
            let container = document.getElementById("achievements-container");
            container.innerHTML = "";

            if (!general_achievements || general_achievements.length === 0) {
                let messageDiv = document.createElement("div");
                messageDiv.textContent = no_achievement_message;
                messageDiv.classList.add("text-center", "mt-3", "fw-bold");
                container.appendChild(messageDiv);
                return;
            }

            let achievementsContainer = document.createElement("div");
            achievementsContainer.classList.add("achievements-container");

            general_achievements.forEach(ach => {
                let achDiv = document.createElement("div");
                achDiv.classList.add("achievement-item");
                achDiv.innerHTML = `
            <img src="/images/achievements/${ach}.png"
                 alt="${achievementData[ach]?.name || ach}">
            <div class="achievement-info">
                <h6>${achievementData[ach]?.name || ach}</h6>
                <p>${achievementData[ach]?.descr || ""}</p>
            </div>
        `;
                achievementsContainer.appendChild(achDiv);
            });

            container.appendChild(achievementsContainer);
        }


        function renderGameModeAchievements(selectedMode) {
            let container = document.getElementById("achievements-container");
            container.innerHTML = "";

            let hasAchievements = false; // Flag per verificare se ci sono achievement sbloccati
            if (gamemode_achievements && gamemode_achievements.length > 0) {
                let filteredAchievements = gamemode_achievements.filter(a => a.gameMode === selectedMode);
                let groupedByClassUT = groupBy(filteredAchievements, "classUT");

                for (let classUT in groupedByClassUT) {
                    let classUTDiv = document.createElement("div");
                    classUTDiv.innerHTML = `<div class='class-ut'>${classUT}</div>`;

                    let groupedByRobot = groupBy(groupedByClassUT[classUT], "type");
                    hasAchievements = false;
                    for (let robotType in groupedByRobot) {
                        let robotDiv = document.createElement("div");
                        let groupedByDifficulty = groupBy(groupedByRobot[robotType], "difficulty");

                        for (let difficulty in groupedByDifficulty) {
                            let difficultyText = difficulty === "EASY" ? difficultyTranslation.easy :
                                difficulty === "MEDIUM" ? difficultyTranslation.medium :
                                    difficultyTranslation.hard;

                            let difficultyTitle = document.createElement("div");
                            difficultyTitle.classList.add("robot-difficulty");
                            difficultyTitle.innerText = `${robotType} - ${difficultyText}`;

                            let achievementsContainer = document.createElement("div");
                            achievementsContainer.classList.add("achievements-container");

                            groupedByDifficulty[difficulty].forEach(achievement => {
                                if (achievement.achievements) {
                                    achievement.achievements.forEach(ach => {
                                        let achDiv = document.createElement("div");
                                        achDiv.classList.add("achievement-item");
                                        achDiv.innerHTML = `
                                <img src="/images/achievements/${ach}.png"
                                     alt="${achievementData[ach]?.name || ach}">
                                <div class="achievement-info">
                                    <h6>${achievementData[ach]?.name || ach}</h6>
                                    <p>${achievementData[ach]?.descr || ""}</p>
                                </div>
                            `;
                                        achievementsContainer.appendChild(achDiv);
                                        hasAchievements = true; // Segnala che almeno un obiettivo Ã¨ stato aggiunto
                                    });
                                }
                            });

                            if (achievementsContainer.children.length !== 0) {
                                robotDiv.appendChild(difficultyTitle);
                                robotDiv.appendChild(achievementsContainer);
                            }
                        }

                        classUTDiv.appendChild(robotDiv);
                    }

                    if (hasAchievements)
                        container.appendChild(classUTDiv);
                }
            }

            // Se non ci sono obiettivi, aggiungo il messaggio "Nessun obiettivo sbloccato"
            if (!hasAchievements) {
                let messageDiv = document.createElement("div");
                messageDiv.textContent = no_achievement_message;
                messageDiv.classList.add("text-center", "mt-3", "fw-bold");
                container.appendChild(messageDiv);
            }
        }

        document.getElementById("game-mode-select").addEventListener("change", function () {
            if (this.value === "General")
                renderGeneralAchievements();
            else
                renderGameModeAchievements(this.value);
        });

        renderGameModeAchievements("PartitaSingola");
    });
</script>
</body>
</html>
