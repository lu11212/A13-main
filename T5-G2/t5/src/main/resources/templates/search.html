<!DOCTYPE html>
<html lang="it" data-bs-theme="dark">
<head>
    <div th:replace ="fragments/header :: header"></div>
    <title>Profile</title>
</head>

<body >

<!-- NAVBAR -->
<div th:replace="fragments/navbar :: navbar"></div>

      <div class="container">
        <div class="card">
          <!-- Search Friend-->
          <div class="d-flex align-items-center justify-content-between p-3 my-3 rounded shadow-sm bg-dark-subtle">
            <div class="friend-search">
              <i class="fas fa-search search-icon"></i>
              <input type="text" id="friend-search-input" class="form-control" autocomplete="off">
            </div>
            <!-- Bottoni -->
            <nav>
                <ul class="pagination m-0">
                    <li class="page-item">
                    <a class="page-link" href="#" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                    </li>
                    <li class="page-item"><a class="page-link" href="#">1</a></li>
                    <li class="page-item"><a class="page-link" href="#">2</a></li>
                    <li class="page-item"><a class="page-link" href="#">3</a></li>
                    <li class="page-item">
                    <a class="page-link" href="#" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                    </li>
                </ul>
            </nav>
          </div>
          <!-- Sec Bottom -->
          <div class="row row-cols-2 text-center" id="followers_block">
              <!-- Profile card -->
              <div class="col mb-4">
                <!-- Friend card -->
                <div class="card" style="display: none;">
                  <div class="card-body p-4 d-flex align-items-center gap-3">
                      <div class="text-start">
                        <h5 class="fw-semibold mb-0">
                            Nome Cognome
                        </h5>
                        <span class="fs-5 d-flex align-items-center">
                          email@email.it
                        </span>
                      </div>
                      <a class="btn btn-primary py-1 px-2 ms-auto" href="#" role="button">Link</a>                     
                  </div>
                </div>

                <!-- Allert -->
                <div class="alert alert-primary" role="alert" id="init_alert" style="display: none;">
                   Cerca utenti per email, nome e cognome oppure nickname!
                </div>

                <!-- Loading -->
                <div class="spinner-border" role="status" id="loadingAlert" style="display: none;">
                    <span class="visually-hidden">Loading...</span>
                </div>
              </div>
          </div>
        </div>
    </div>


<div th:replace="fragments/footer :: footer"></div>

<script>
  $(document).ready(function() {
    let currentPage = 0;
    let pageSize = 10;
    let timeoutId;

    $("#init_alert").show();

// 1. Aggiorna la funzione di successo della ricerca
    function searchUserProfiles(searchTerm, page, size) {
        $.ajax({
            url: "/profile/search_api",
            type: "GET",
            data: { searchTerm: searchTerm, page: page, size: size },
            dataType: "json",
            success: function(response) {
                console.log("Risultati:", response);
                $("#loadingAlert").hide();
                
                // Aggiorniamo la pagina corrente globale
                currentPage = page; 

                updateResults(response);
                updatePagination(response);
            },
            error: function(xhr, status, error) {
                console.error("Errore:", error);
                $("#loadingAlert").hide();
            }
        });
    }

    // 2. Aggiornamento Risultati
    function updateResults(data) {
        let resultsContainer = $("#followers_block");
        resultsContainer.empty();

        if (!data || !data.content || data.content.length === 0) {
            resultsContainer.append("<p class='w-100 text-center text-white'>Nessun risultato trovato.</p>");
            return;
        }

        data.content.forEach(user => {
            // FIX IMMAGINE: Se manca, usa il default nel percorso corretto
            let pic = user.profilePicturePath ? user.profilePicturePath : 'default.png';
            let imgUrl = '/t5/images/profileImages/' + pic;

            // FIX NOME: Fallback se null
            let fullName = (user.name || '') + " " + (user.surname || '');
            
            // FIX LINK: T23 restituisce "userId" nel JSON
            let friendLink = '/friend/' + (user.userId || user.id || 0);

            resultsContainer.append(
                `<div class="col mb-4">
                    <div class="card bg-dark border-secondary">
                        <div class="card-body p-4 d-flex align-items-center gap-3">
                            <img src="${imgUrl}"
                                 alt="Avatar" width="50" height="50" 
                                 class="rounded-circle flex-shrink-0"
                                 style="object-fit: cover;"
                                 onerror="this.src='/t5/images/profileImages/default.png'">
                            <div class="text-start">
                                <h5 class="fw-semibold mb-0 text-white">${fullName}</h5>
                                <span class="fs-6 d-flex align-items-center text-muted">@${user.nickname}</span>
                            </div>
                            <a class="btn btn-primary py-1 px-2 ms-auto" href="${friendLink}">Vedi</a>                     
                        </div>
                    </div>
                </div>`
            );
        });
    }

// 2. Aggiorna la funzione di paginazione (Fix per l'errore undefined)
    function updatePagination(data) {
        let paginationContainer = $(".pagination");
        paginationContainer.empty();

        // Se non ci sono pagine o ce n'Ã¨ una sola, nascondi la paginazione
        if (!data.totalPages || data.totalPages <= 1) return;

        let totalPages = data.totalPages;
        
        // --- Precedente ---
        let prevDisabled = currentPage === 0 ? 'disabled' : '';
        paginationContainer.append(
            `<li class="page-item ${prevDisabled}">
                <a class="page-link bg-dark border-secondary text-white" href="#" data-page="${currentPage - 1}">&laquo;</a>
            </li>`
        );

        // --- Numeri ---
        // Mostriamo un range limitato per evitare 1000 bottoni
        let startPage = Math.max(0, currentPage - 2);
        let endPage = Math.min(totalPages - 1, currentPage + 2);

        for (let i = startPage; i <= endPage; i++) {
            let active = i === currentPage ? 'active' : '';
            let bgClass = active ? 'bg-primary border-primary' : 'bg-dark border-secondary text-white';
            
            paginationContainer.append(
                `<li class="page-item ${active}">
                    <a class="page-link ${bgClass}" href="#" data-page="${i}">${i + 1}</a>
                </li>`
            );
        }

        // --- Successivo ---
        let nextDisabled = currentPage === totalPages - 1 ? 'disabled' : '';
        paginationContainer.append(
            `<li class="page-item ${nextDisabled}">
                <a class="page-link bg-dark border-secondary text-white" href="#" data-page="${currentPage + 1}">&raquo;</a>
            </li>`
        );
    }

    // 4. Input Handler (con ritardo per non spammare il server)
    $("#friend-search-input").on("input", function() {
        let searchTerm = $(this).val();
        clearTimeout(timeoutId);
        
        if(searchTerm.length > 0){
            $("#loadingAlert").show();
            $("#init_alert").hide();
            timeoutId = setTimeout(() => {
                searchUserProfiles(searchTerm, 0, pageSize);
            }, 500); 
        } else {
             $("#loadingAlert").hide();
             $("#init_alert").show();
             $("#followers_block").empty();
        }
    });

    // 5. Click Paginazione
    $(document).on("click", ".page-link", function(e) {
        e.preventDefault();
        let page = $(this).data("page");
        if (page !== undefined && page >= 0) {
            currentPage = page;
            let searchTerm = $("#friend-search-input").val();
            searchUserProfiles(searchTerm, currentPage, pageSize);
        }
    });

  });
</script>

</body>
</html>