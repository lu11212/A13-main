# T7 Module

The T7 service handles the compilation of provided Java code and the calculation of code coverage using JaCoCo.
It can be invoked by:

- T1, to calculate the missing JaCoCo coverage of a robot uploaded by the administrator;
- T5, to verify if the tests written by the player compile and, if so, the coverage achieved.

## Module Structure Overview

The module consists of the following packages and classes:

```html
RemoteCCC.App
├── config
│   └── CustomExecutorConfiguration
├── util
│   ├── BuildResponse
│   └── FileUtil
├── App
├── AppController
├── CompilationService
└── Config
```

In detail:

1. The class `AppController` represents the REST controller that expose the module’s endpoints;
2. The package `config` contains the system’s configurations to handle the concurrency;
3. The class `CopilationService` provides teh services to prepare, compile, execute and calculate the JaCoCo coverage
   metrics for the given class UT and test;
4. The class `Config` defines the configuration necessary to generate the temporary unique folder where the test will
   resides;
5. The package `util` contains all the utility classes of the system.

## Available REST Endpoints

The module expose only two REST endpoint, described in the table below:

| HTTP Method | Endpoint             | Function                                                                                            |
|-------------|----------------------|-----------------------------------------------------------------------------------------------------|
| POST        | `/coverage/opponent` | Calculates the missing JaCoCo coverage for a robot uploaded by the administrator.                   |
| POST        | `/coverage/player`   | Verifies the compilability and the coverage of the JUnit code written by the player during a match. |

## Compile and Coverage Service

The `CompilationService` class implements the logic for compiling and executing the provided JUnit tests, followed by
the computation of coverage metrics using JaCoCo. The execution flow is as follows:

1. The `CoverageService` is triggered when the system receives a compile and coverage analysis request from T1 or T5.
2. The class creates a temporary directory on the system and sets it up as a Maven project, using the configuration
   specified in the class `Config`. Inside this directory, it places the received source code (including the class under
   test and the JUnit tests) and a suitable `pom.xml` file.
3. It runs the necessary Maven commands to compile the project and install dependencies. Then the project will be
   executed and the JaCoCo metrics will be calculated.  
   The coverage criteria considered are:
    * LINE;
    * BRANCH;
    * INSTRUCTION.
4. The class will return to the controller the result of the compilation with Maven and, if successful, the metrics
   calculated.
5. After processing, the class deletes all temporary files and folders generated during the operation to prevent disk
   clutter.

This workflow ensures complete isolation of each request, providing a safe and independent execution environment for
every user.

## Executor and Task Queue

To handle multiple compilation requests from players within a limited time frame, T8 uses a system based on task queues
and an executor.

The Spring configuration class `CustomExecutorConfiguration` defines a specialized executor service designed to handle
tasks with strict timing constraints on queue waiting time and execution duration. It is tailored
for scenarios where tasks must not be queued or executed beyond specified time limits, ensuring responsiveness and
preventing stale or excessively long-running tasks.
In details:

1. Both core and max pool sizes are set to 1, ensuring tasks execute sequentially;
2. The task queue has a maximum capacity (`MAX_QUEUE_SIZE` = 12);
3. Tasks waiting longer than `MAX_QUEUE_TIME` (3 minutes) in the queue are automatically removed and marked as expired;
4. Task execution is limited to `EXECUTION_TIME_THRESHOLD` (2.5 minutes);
5. The system keeps track of recent execution durations to make informed decisions about task rejection;
6. Tasks are rejected when the queue is full or average execution time is too high;
7. A dedicated thread periodically scans the queue to remove tasks that have exceeded their maximum waiting time.
8. The config provides support for futures with completion on success or failure, enabling asynchronous task management.

The following table summarize the role of the (sub)classes described in the configuration.

| **Class / Interface**         | **Type**                                      | **Description**                                                                                                   |
|-------------------------------|-----------------------------------------------|-------------------------------------------------------------------------------------------------------------------|
| `CustomExecutorConfiguration` | `@Configuration` class                        | Spring configuration defining a custom executor with task timing and expiration controls.                         |
| `TimedRunnable`               | Interface                                     | Extends `Runnable` adding method to get the task enqueue time (`getEnqueueTime()`).                               |
| `ExecutionTimeMonitor`        | Class                                         | Tracks recent execution times and calculates average execution duration to guide rejection policies.              |
| `TimedTask<V>`                | Class (Callable & Runnable)                   | Wraps user task to monitor queue wait time and execution timeout, supports task expiration and future completion. |
| `ExpiringBlockingQueue`       | Class (extends `LinkedBlockingQueue`)         | Queue with capacity limit that rejects or removes expired tasks based on max wait time in queue.                  |
| `ExpiringTaskCleaner`         | Class                                         | Background daemon thread that periodically scans and removes expired tasks from the queue.                        |
| `SmartRejectHandler`          | Class (implements `RejectedExecutionHandler`) | Custom rejection handler that rejects tasks based on queue capacity or average execution time thresholds.         |
| `CustomExecutorService`       | Class                                         | Wrapper service exposing task submission method that submits `TimedTask`s to the configured executor.             |


