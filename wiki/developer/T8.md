# T8 Module

The T8 service handles the compilation of provided Java code and the calculation of the metrics of EvoSuite.
It can be invoked by:

- T1, to calculate the missing EvoSuite metrics of a robot uploaded by the administrator;
- T5, to calculate the EvoSuite metrics achieved by the JUnit code written by the player during a match.

## Module Structure Overview

The module consists of a set of packages, as shown below:

```html
com.robotchallenge.t8
├── config
├── controller
│ └── advice
├── dto
│ └── request
├── service
└── util
```

In detail:

1. The package `controller` contains the REST controllers that expose the module’s endpoints. The subpackage `advice`
   includes global exception handlers, which translate service-layer unchecked exceptions into appropriate HTTP
   responses;
2. The package `config` contains the system’s configurations to handle the concurrency;
3. The package `dto`, and specifically its subpackage `request`, holds the Data Transfer Objects used for communication
   with the other services.
4. The package `service` contains the business logic of the module, while the `exception` subpackage defines a custom
   exception class used to wrap the checked exceptions thrown by the module and rethrow them as unchecked exceptions.
5. The package `util` contains all the utility classes of the system.

## Available REST Endpoints

The module expose only two REST endpoint, described in the table below:

| HTTP Method | Endpoint             | Function                                                                               |
|-------------|----------------------|----------------------------------------------------------------------------------------|
| POST        | `/coverage/opponent` | Calculates the missing EvoSuite metrics for an opponent uploaded by the administrator. |
| POST        | `/coverage/player`   | Calculate the EvoSuite metrics for the code written by the player during a match.      |

## Coverage Service (for player requests)

The `CoverageService` class, located in the `service` package, implements the logic for compiling and executing the
provided JUnit tests, followed by the computation of coverage metrics using EvoSuite. The execution flow is as follows:

1. The `CoverageService` is triggered when the system receives a coverage analysis request from another service within
   the architecture.
2. The class creates a temporary directory on the system and sets it up as a Maven project. Inside this directory, it
   places the received source code (including the class under test and the JUnit tests), the required EvoSuite JAR
   files, and a suitable `pom.xml` file.
3. It runs the necessary Maven commands to compile the project and install dependencies. Then, it executes EvoSuite to
   calculate the following metrics:
    * LINE
    * BRANCH
    * EXCEPTION
    * WEAKMUTATION
    * OUTPUT
    * METHOD
    * METHODNOEXCEPTION
    * CBRANCH

   Since EvoSuite is compatible only with Java 8, the class enforces the use of this Java version for running the tool.
4. If the execution is successful, the class collects the results produced by EvoSuite and returns them to the
   controller, which prepares the data to be sent back to the requesting service. In case of failure, an appropriate
   error is returned.
5. After processing, the class deletes all temporary files and folders generated during the operation to prevent disk
   clutter.

This workflow ensures complete isolation of each request, providing a safe and independent execution environment for
every user.

## Executor and Task Queue

To handle multiple compilation requests from players within a limited time frame, T8 uses a system based on task queues
and an executor.

The Spring configuration class `CustomExecutorConfiguration` defines a specialized executor service designed to handle
tasks with strict timing constraints on queue waiting time and execution duration. It is tailored
for scenarios where tasks must not be queued or executed beyond specified time limits, ensuring responsiveness and
preventing stale or excessively long-running tasks.
In details:

1. Both core and max pool sizes are set to 1, ensuring tasks execute sequentially;
2. The task queue has a maximum capacity (`MAX_QUEUE_SIZE` = 12);
3. Tasks waiting longer than `MAX_QUEUE_TIME` (3 minutes) in the queue are automatically removed and marked as expired;
4. Task execution is limited to `EXECUTION_TIME_THRESHOLD` (2.5 minutes);
5. The system keeps track of recent execution durations to make informed decisions about task rejection;
6. Tasks are rejected when the queue is full or average execution time is too high;
7. A dedicated thread periodically scans the queue to remove tasks that have exceeded their maximum waiting time.
8. The config provides support for futures with completion on success or failure, enabling asynchronous task management.

The following table summarize the role of the (sub)classes described in the configuration.

| **Class / Interface**         | **Type**                                      | **Description**                                                                                                   |
|-------------------------------|-----------------------------------------------|-------------------------------------------------------------------------------------------------------------------|
| `CustomExecutorConfiguration` | `@Configuration` class                        | Spring configuration defining a custom executor with task timing and expiration controls.                         |
| `TimedRunnable`               | Interface                                     | Extends `Runnable` adding method to get the task enqueue time (`getEnqueueTime()`).                               |
| `ExecutionTimeMonitor`        | Class                                         | Tracks recent execution times and calculates average execution duration to guide rejection policies.              |
| `TimedTask<V>`                | Class (Callable & Runnable)                   | Wraps user task to monitor queue wait time and execution timeout, supports task expiration and future completion. |
| `ExpiringBlockingQueue`       | Class (extends `LinkedBlockingQueue`)         | Queue with capacity limit that rejects or removes expired tasks based on max wait time in queue.                  |
| `ExpiringTaskCleaner`         | Class                                         | Background daemon thread that periodically scans and removes expired tasks from the queue.                        |
| `SmartRejectHandler`          | Class (implements `RejectedExecutionHandler`) | Custom rejection handler that rejects tasks based on queue capacity or average execution time thresholds.         |
| `CustomExecutorService`       | Class                                         | Wrapper service exposing task submission method that submits `TimedTask`s to the configured executor.             |