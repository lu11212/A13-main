# T1 Module

The **T1 module** of the system manages the web pages and services available to administrators. The current version
allows administrators to:

1. View registered administrators and players;
2. Add new Java classes to be tested along with their corresponding opponents;
3. View and delete previously uploaded classes and their associated opponents.

A more detailed description of the available features can be found in the *Professor's Guide*.

## Module Structure Overview

The module consists of a set of packages, as shown below:

```html
com.groom.manvsclass
├── api
├── config
├── controller
│   └── view
├── model
│   ├── dto
│   └── repository
├── security
├── service
│   └── exception
├── util
│   └── filesystem
└── ManvsclassApplication

```

In detail:

1. The package `controller` contains the REST controllers that expose the module’s endpoints.
   The subpackage `view` contains controllers for handling view-based requests;
2. The package `config`  provides all classes necessary for handling language switching and localization;
3. The package `model` defines the core domain model of the module.
   The subpackage `dto` holds all Data Transfer Objects used for communication with the client,
   while the subpackage `repository` includes Spring Data JPA repositories for accessing and persisting entities in the
   database;
4. The package `security` includes all classes related to handling the module’s security;
5. The package `service` contains the business logic of the module. Each service focuses on a specific area of
   functionality, such as user management or authentication.
   The subpackage `exceptions` defines all the custom exceptions thrown by the service layer to signal domain-specific
   errors;
6. The package `util`
7. The package `api` centralize all the inter-service API communication.

## Centralized API Calls

The `api` subpackage is structured as follows:

```html
api
├── ApiGatewayClient
└── RestExchangeTemplateHelper
```

The `RestExchangeTemplateHelper` provides a template for performing REST API calls, while the `ApiGatewayClient`
centralizes all
REST API invocations, simplifying communication across the module and making maintenance easier.

## Authentication and Security

The `security` package handles the security related to teh module. Its structure is the following:

```html
security
├── AuthTokenFilter
├── FilterConfig
└── JwtRequestContext
```

The `JwtRequestContext` class is a utility designed to store the JWT received in the user's request. This token is then
used in all subsequent internal
communications between modules, ensuring that these communications are properly authenticated.

The `AuthTokenFilter` is a filter responsible for verifying whether the incoming HTTP request is authenticated. It
checks for the presence of a JWT
in the COOKIES section of the request and validates it. The validation is performed by communicating with T23.

If the JWT is valid, the filter allows the request to proceed, and the module can start processing it. The JWT is stored
by `JwtRequestContext` as said above.

If the JWT is missing or invalid (e.g., expired), the filter checks for the presence of a Refresh Token. If a Refresh
Token is found, it is sent to T23 for validation.
If the Refresh Token is successfully validated, T23 issues a new JWT and, at the same time, authenticates the request.
The new JWT is then added by T1 to
the response sent back to the client, ensuring the old token is updated.

Before processing the request, the filter performs one final check on the validated JWT: it verifies the role associated
with the token.
Although T1 is primarily used by administrators, it may also receive internal requests from T5, which is associated with
player roles.

The filter verifies the role linked to the JWT — again through T23 — and compares it with the requested URL.
If the URL is permitted for the given role, the request is allowed to proceed. Otherwise, it is rejected.

The filter is enabled by `FilterConfig` for all the incoming HTTP requests.